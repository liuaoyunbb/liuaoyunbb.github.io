---
title: 深入学习MongoDB笔记
date: 2018-12-10 21:59:50
tags:
    - MongoDb
---

## 第二章 理解分片
### 2.1 分割数据
分片是集群中负责数据某一子集的一台或多台服务器。一个分片可以由多台服务器组成，如果分片包含不止一台服务器，则每台服务器都有一份完全相同的数据子集的副本，一个分片通常是一个副本集。
#### 2.1.1 分配数据
1. 一分片一区间
一分片一区间会导致级联效应：必须移动数据到“下一台”服务器上，即使不能改善平衡性
2. 一分片多区间
让分片支持多重非连续区间，我们便可以挑选数据并将其移动到任何地方。
添加新分片时，每个分片都可以直接给它提供数据
MongoDB的分配之道：当一个块变得越来越大时，MongoDB会自动将其分割成两个较小的块，如果分片间比例失衡，则MongoDB会通过迁移块来确保均衡。
#### 2.1.2 创建数据块
MongoDB不允许插入无片键的文档，也不允许修改片键值。给文档一个新片键的唯一方法是先删除文档，然后在客户端修改片键的值，再重新插入文档。
MongoDB数据块默认大小是200MB，挪动数据块的代价非常大，299MB恰好是兼顾可移动性和最小开销的最佳选择。

### 2.2. 平衡
如果存在多个可用的分片，只要数据块的数量足够多，MongoDB会将数据迁移到其他分片上。这个迁移过程叫做平衡(balancing)，由平衡器(balancer)的进程负责执行。
如果每一点轻微的不平衡都要被修正，则最终必然导致大量不必要的数据移动。
要触发一轮平衡，一个分片必须比块最小的分片多出至少9个块。
自定义块大小
--chunkSize N(MB)
递增块大小
对于前十几个块，MongoDB会特意自动降低块大小，从200MB降到64MB，一旦数据块多起来，自动将块递增到200MB

### 2.3 mongos
mongos是用户和集群间的交互点，其职责是隐藏分片内部的复杂性并想用户提供一个简洁的单服务器接口。
如果一个查询包含片键，mongos会将请求路由到包含对应块的分片上。

### 2.4 配置服务器
配置服务器config server包含了有关集群的最完整的可靠的信息以供分片、mongos进程和系统管理员访问。
任何一台配置服务器停机、集群配置都无法改变。

### 2.5 集群的构建

## 第三章 建立集群
### 3.1 选择片键
#### 3.1.1 小基数片键(low-cardinality shard key)
如果一个集合中一个键有N个取值，那就只能有N个数据块，因此也只能有N个分片。
#### 3.1.2 升序片键
时间戳、日期、ObjectId、自增主键
容易导致单一且不可分数的热点

#### 3.1.3 随机片键
当需要平衡数据块时，考虑到数据的随机性，一般情况下这些数据可能不会存在于内存中，此时MongoDB需要随机加载数据块到内存中并发送给分片，此时MongoDB给RAM带来很大压力，会引发大量磁盘IO。
片键上必须有索引。

#### 3.1.4 好的片键
- 良好的数据局部性
- 查询的隔离性
1. 准升序键加搜索键
组合片键{coarselyAscending:1, search:1}
coarselyAscending键的每个值最好能对应几十到几百个数据块，用来控制数据局部化，而search键最好是应用程序可以用于查询的字段，比如userId，它应具备非升序、分布随机且基数适当的特点。
选择片键之前可先针对应用程序特定调查如下问题：
- 写操作是怎样的？要插入什么文档？有多大？
- 系统每小时会写入多少数据？每天呢？高峰期呢？
- 哪些字段取值是随机的？哪些是增长的？
- 读操作是怎样的？人们访问哪些数据？
- 系统每小时会读入多少数据？每天呢？高峰期呢？
- 哪些字段做了索引？应不应该索引呢？
- 数据总量有多少？
- 机器基本情况

### 3.2 新老集合分片
#### 3.2.1 Github mongo-snippets
https://github.com/mongodb/mongo-snippets/tree/master/sharding
#### 3.2.2 配置服务器
#### 3.2.3 mongos
一个分片配置需要至少一个mongos，一般来说每个应用程序服务器一个mongos进程就好。
#### 3.2.4 分片
限制分片大小
#### 3.2.5 数据库和集合
如果要对一个已经包含数据的集合进行分片，数据片键上必须有索引，所有文档也都必须有片键值(值不能为null)。
对集合进行分片
```
// 分片命令

// 开启分片
```

### 3.3 增减容量
不要等到服务器容量耗尽时再添加分片，此时添加分片可能导致应用程序逐步瘫痪。
在还有足够空间做调度时添加分片，或者在非忙时间再添加分片。

## 第四章 使用集群
### 4.1 查询
### 4.2 问题
## 第五章 管理